<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Elasticsearch Demo</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', Arial, sans-serif;
            background-color: #f8f9fa;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        .sidebar {
            min-height: calc(100vh - 56px);
            background-color: #343a40;
            color: white;
        }
        .sidebar a {
            color: rgba(255, 255, 255, 0.8);
            text-decoration: none;
            display: block;
            padding: 10px 15px;
            transition: all 0.3s;
        }
        .sidebar a:hover {
            background-color: #495057;
            color: white;
        }
        .sidebar a.active {
            background-color: #0d6efd;
            color: white;
        }
        .content {
            padding: 20px;
            flex: 1;
        }
        .card {
            margin-bottom: 20px;
            border: none;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        .card-header {
            background-color: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
            border-radius: 8px 8px 0 0;
        }
        .loading {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(255, 255, 255, 0.9);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            text-align: center;
        }
        .footer {
            background-color: #f8f9fa;
            padding: 20px 0;
            margin-top: auto;
            border-top: 1px solid #e9ecef;
        }
        .nav-tabs {
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="fab fa-elasticsearch text-warning mr-2"></i>Elasticsearch Demo
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link active" aria-current="page" href="/index">数据查询</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/system">系统管理</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- Main Content -->
            <main class="col-md-12 content">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-search text-primary mr-2"></i>数据查询
                        </h5>
                    </div>
                    <div class="card-body">
                        <!-- Tab导航 -->
                        <div class="mb-4">
                            <ul class="nav nav-tabs" id="queryTabs" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link active" id="dynamic-tab" data-bs-toggle="tab" data-bs-target="#dynamic" type="button" role="tab" aria-controls="dynamic" aria-selected="true">
                                        <i class="fas fa-sliders-h mr-1"></i>动态查询
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="raw-tab" data-bs-toggle="tab" data-bs-target="#raw" type="button" role="tab" aria-controls="raw" aria-selected="false">
                                        <i class="fas fa-database mr-1"></i>原数据查询
                                    </button>
                                </li>
                            </ul>
                        </div>

                        <!-- Tab内容 -->
                        <div class="tab-content" id="queryTabsContent">

                            <!-- 动态查询表单 -->
                            <div class="tab-pane fade show active" id="dynamic" role="tabpanel" aria-labelledby="dynamic-tab">
                                <div class="card mb-4">
                                    <div class="card-header d-flex justify-content-between align-items-center">
                                        <h6 class="mb-0">
                                            <i class="fas fa-search-plus text-primary mr-2"></i>动态条件查询
                                        </h6>
                                        <button class="btn btn-sm btn-outline-primary" id="loadFieldsBtn">
                                            <i class="fas fa-sync-alt mr-1"></i>加载字段
                                        </button>
                                    </div>
                                    <div class="card-body">
                                        <div class="row mb-4">
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label for="dynamicIndexName" class="form-label">索引名称 <span class="text-danger">*</span></label>
                                                    <input type="text" id="dynamicIndexName" class="form-control" 
                                                           th:value="${currentIndex}" placeholder="请输入Elasticsearch索引名称" required>
                                                </div>
                                            </div>
                                            <div class="col-md-2">
                                                <div class="mb-3">
                                                    <label for="dynamicPage" class="form-label">页码</label>
                                                    <input type="number" id="dynamicPage" class="form-control" min="0" value="0" placeholder="页码">
                                                </div>
                                            </div>
                                            <div class="col-md-2">
                                                <div class="mb-3">
                                                    <label for="dynamicSize" class="form-label">每页大小</label>
                                                    <input type="number" id="dynamicSize" class="form-control" min="1" max="100" value="10" placeholder="每页大小">
                                                </div>
                                            </div>
                                            <div class="col-md-2">
                                                <div class="d-grid gap-2 mt-3">
                                                    <button class="btn btn-sm btn-primary" id="addConditionBtn">
                                                        <i class="fas fa-plus mr-1"></i>添加条件
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- 字段选择和查询条件区域 -->
                                        <div id="fieldsContainer" class="mb-3">
                                            <div class="alert alert-info" role="alert">
                                                <i class="fas fa-info-circle mr-2"></i>
                                                请先输入索引名称并点击"加载字段"按钮获取字段信息
                                            </div>
                                        </div>
                                        
                                        <!-- 查询条件列表 -->
                                        <div id="conditionsContainer" class="border p-3 rounded mb-3">
                                            <div class="text-center text-muted py-3">
                                                <i class="fas fa-list-ul mr-2"></i>暂无查询条件，请点击"添加条件"
                                            </div>
                                        </div>
                                        
                                        <div class="d-flex justify-content-between">
                                            <button class="btn btn-outline-secondary" id="clearConditionsBtn">
                                                <i class="fas fa-trash-alt mr-2"></i>清空条件
                                            </button>
                                            <button class="btn btn-primary" id="dynamicSearchBtn">
                                                <i class="fas fa-search mr-2"></i>执行查询
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 原数据查询表单 -->
                            <div class="tab-pane fade" id="raw" role="tabpanel" aria-labelledby="raw-tab">
                                <div class="row g-3 align-items-end">
                                    <div class="col-md-4">
                                        <div class="mb-3">
                                            <label for="rawIndexName" class="form-label">索引名称 <span class="text-danger">*</span></label>
                                            <input type="text" id="rawIndexName" class="form-control" 
                                                   th:value="${currentIndex}" placeholder="请输入Elasticsearch索引名称" required>
                                        </div>
                                    </div>
                                    <div class="col-md-2">
                                        <div class="mb-3">
                                            <label for="rawPage" class="form-label">页码</label>
                                            <input type="number" id="rawPage" class="form-control" min="0" value="0" placeholder="页码">
                                        </div>
                                    </div>
                                    <div class="col-md-2">
                                        <div class="mb-3">
                                            <label for="rawSize" class="form-label">每页大小</label>
                                            <input type="number" id="rawSize" class="form-control" min="1" max="100" value="10" placeholder="每页大小">
                                        </div>
                                    </div>
                                    <div class="col-md-4">
                                        <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                            <button class="btn btn-primary" id="searchRawDataBtn">
                                                <i class="fa fa-search mr-2"></i>查询原数据
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 加载中 -->
                <div id="loading" class="loading">
                    <div class="spinner-border text-primary" role="status">
                        <span class="sr-only">加载中...</span>
                    </div>
                    <p class="mt-2">正在加载数据，请稍候...</p>
                </div>

                <!-- 消息提示 -->
                <div id="messageContainer" class="mb-4">
                    <!-- 消息将通过JavaScript动态加载 -->
                </div>

                <!-- 数据列表 -->
                <div id="dataContainer" class="data-container">
                    <!-- 数据将通过JavaScript动态加载 -->
                </div>
            </main>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer">
        <div class="container text-center">
            <p class="mb-0">© 2024 Spring Boot Elasticsearch Demo | 基于 Spring Boot 3.x 和 Elasticsearch</p>
        </div>
    </footer>

    <!-- 数据详情模态框 -->
    <div class="modal fade" id="detailsModal" tabindex="-1" aria-labelledby="detailsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="detailsModalLabel">数据详情</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <!-- 标签页导航 -->
                    <div class="mb-3">
                        <ul class="nav nav-tabs" id="detailsTabs" role="tablist">
                            <li class="nav-item" role="presentation">
                                <button class="nav-link active" id="formatted-tab" data-bs-toggle="tab" data-bs-target="#formatted" type="button" role="tab" aria-controls="formatted" aria-selected="true">
                                    <i class="fa fa-list-alt mr-1"></i>格式化视图
                                </button>
                            </li>
                            <li class="nav-item" role="presentation">
                                <button class="nav-link" id="json-tab" data-bs-toggle="tab" data-bs-target="#json" type="button" role="tab" aria-controls="json" aria-selected="false">
                                    <i class="fa fa-code mr-1"></i>原始JSON
                                </button>
                            </li>
                        </ul>
                    </div>
                    
                    <!-- 标签页内容 -->
                    <div class="tab-content" id="detailsTabsContent">
                        <!-- 格式化视图 -->
                        <div class="tab-pane fade show active" id="formatted" role="tabpanel" aria-labelledby="formatted-tab">
                            <div id="detailsContent">
                                <!-- 格式化内容将通过JavaScript动态生成 -->
                            </div>
                        </div>
                        
                        <!-- 原始JSON视图 -->
                        <div class="tab-pane fade" id="json" role="tabpanel" aria-labelledby="json-tab">
                            <div class="mb-2 d-flex justify-content-between align-items-center">
                                <span><i class="fa fa-info-circle text-info"></i> 原始JSON数据</span>
                                <button id="copyJsonBtn" class="btn btn-sm btn-outline-primary">
                                    <i class="fa fa-copy mr-1"></i>复制JSON
                                </button>
                            </div>
                            <pre id="jsonContent" class="bg-dark text-white p-3 rounded overflow-auto" style="max-height: 500px;">
                                <!-- JSON内容将通过JavaScript动态生成 -->
                            </pre>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 全新实现的Elasticsearch Demo前端逻辑
        document.addEventListener('DOMContentLoaded', function() {
            // DOM元素引用，使用局部变量避免全局冲突
            const rawIndexNameField = document.getElementById('rawIndexName');
            const searchRawDataButton = document.getElementById('searchRawDataBtn');
            const dataContainerElement = document.getElementById('dataContainer');
            const messageContainerElement = document.getElementById('messageContainer');
            const loadingIndicator = document.getElementById('loading');
            const detailsModalElement = document.getElementById('detailsModal');
            const detailsContentElement = document.getElementById('detailsContent');
            const jsonContentElement = document.getElementById('jsonContent');
            const copyJsonButton = document.getElementById('copyJsonBtn');
            
            // 当前选中的数据项
            let selectedDataItem = null;
            
            // 初始化函数
                function initialize() {
                    // 隐藏不需要的按钮（如果存在）
                    const addUserBtn = document.getElementById('addUserBtn');
                    const initDataBtn = document.getElementById('initDataBtn');
                    if (addUserBtn) addUserBtn.style.display = 'none';
                    if (initDataBtn) initDataBtn.style.display = 'none';
                    
                    // 绑定事件处理程序
                    bindEventHandlers();
                    
                    // 初始化字段同步
                    syncIndexNames();
                    
                    // 初始加载数据
                    // loadSearchData(); // 暂时注释掉，避免自动加载过多数据
                }
                
                // 同步索引名称输入框
                function syncIndexNames() {
                    const allIndexInputs = [
                        document.getElementById('rawIndexName'),
                        document.getElementById('dynamicIndexName')
                    ];
                    
                    allIndexInputs.forEach(input => {
                        if (input) {
                            input.addEventListener('change', function() {
                                const value = this.value.trim();
                                if (value) {
                                    allIndexInputs.forEach(otherInput => {
                                        if (otherInput && otherInput !== this && !otherInput.value.trim()) {
                                            otherInput.value = value;
                                        }
                                    });
                                }
                            });
                        }
                    });
                }
            
            // 绑定事件处理程序
                function bindEventHandlers() {
                    // 查询原始数据按钮点击事件
                    searchRawDataButton.addEventListener('click', function() {
                        loadRawData();
                    });
                    
                    // 复制JSON按钮点击事件
                    copyJsonButton.addEventListener('click', function() {
                        if (jsonContentElement.textContent.trim()) {
                            navigator.clipboard.writeText(jsonContentElement.textContent)
                                .then(() => showMessage('success', '复制成功'))
                                .catch(() => showMessage('error', '复制失败'));
                        }
                    });
                    
                    // 使用事件委托处理查看详情按钮
                    document.addEventListener('click', function(event) {
                        const detailsButton = event.target.closest('.view-details-btn');
                        if (detailsButton) {
                            const itemData = detailsButton.getAttribute('data-item');
                            if (itemData) {
                                showDataDetails(itemData);
                            }
                        }
                        
                        // 删除条件按钮点击事件
                        const deleteConditionBtn = event.target.closest('.delete-condition-btn');
                        if (deleteConditionBtn) {
                            const conditionRow = deleteConditionBtn.closest('.condition-row');
                            if (conditionRow) {
                                conditionRow.remove();
                                updateConditionsContainerState();
                            }
                        }
                        
                        // 条件类型变化事件
                        const conditionTypeSelect = event.target.closest('.condition-type-select');
                        if (conditionTypeSelect) {
                            updateConditionInput(conditionTypeSelect);
                        }
                    });
                    
                    // 动态查询相关事件
                    const loadFieldsBtn = document.getElementById('loadFieldsBtn');
                    if (loadFieldsBtn) {
                        loadFieldsBtn.addEventListener('click', loadIndexFields);
                    }
                    
                    const addConditionBtn = document.getElementById('addConditionBtn');
                    if (addConditionBtn) {
                        addConditionBtn.addEventListener('click', addNewCondition);
                    }
                    
                    const clearConditionsBtn = document.getElementById('clearConditionsBtn');
                    if (clearConditionsBtn) {
                        clearConditionsBtn.addEventListener('click', clearAllConditions);
                    }
                    
                    const dynamicSearchBtn = document.getElementById('dynamicSearchBtn');
                    if (dynamicSearchBtn) {
                        dynamicSearchBtn.addEventListener('click', performDynamicSearch);
                    }
                }
                
                // 全局变量存储字段信息
                let indexFields = [];
                
                // 加载索引字段信息
                function loadIndexFields() {
                    const indexName = document.getElementById('dynamicIndexName').value.trim();
                    if (!indexName) {
                        showMessage('error', '请输入索引名称');
                        return;
                    }
                    
                    showLoading(true);
                    
                    fetch(`/api/es/fields?indexName=${encodeURIComponent(indexName)}`)
                        .then(response => {
                            if (!response.ok) {
                                throw new Error('网络响应异常');
                            }
                            return response.json();
                        })
                        .then(data => {
                            showLoading(false);
                            if (data.success && Array.isArray(data.data)) {
                                indexFields = data.data;
                                renderFieldsList();
                                showMessage('success', `成功加载 ${data.data.length} 个字段`);
                            } else {
                                showMessage('error', data.message || '加载字段失败');
                            }
                        })
                        .catch(error => {
                            showLoading(false);
                            showMessage('error', '加载字段失败，请检查连接');
                            console.error('加载字段时出错:', error);
                        });
                }
                
                // 渲染字段列表
                function renderFieldsList() {
                    const fieldsContainer = document.getElementById('fieldsContainer');
                    if (!fieldsContainer) return;
                    
                    if (indexFields.length === 0) {
                        fieldsContainer.innerHTML = `
                            <div class="alert alert-warning" role="alert">
                                <i class="fas fa-exclamation-triangle mr-2"></i>
                                未找到索引字段信息，请检查索引名称是否正确
                            </div>
                        `;
                        return;
                    }
                    
                    // 按字段名排序
                    const sortedFields = [...indexFields].sort((a, b) => a.name.localeCompare(b.name));
                    
                    let html = `
                        <div class="mb-2">
                            <span class="badge bg-primary">已加载 ${indexFields.length} 个字段</span>
                            <span class="text-muted ml-2">(点击"添加条件"开始构建查询)</span>
                        </div>
                        <div class="table-responsive">
                            <table class="table table-sm table-hover">
                                <thead>
                                    <tr>
                                        <th>字段名</th>
                                        <th>类型</th>
                                    </tr>
                                </thead>
                                <tbody>
                    `;
                    
                    sortedFields.forEach(field => {
                        html += `
                            <tr>
                                <td>${escapeHtml(field.name)}</td>
                                <td><span class="badge bg-secondary">${field.type}</span></td>
                            </tr>
                        `;
                    });
                    
                    html += `
                                </tbody>
                            </table>
                        </div>
                    `;
                    
                    fieldsContainer.innerHTML = html;
                }
                
                // 添加新的查询条件
                function addNewCondition() {
                    if (indexFields.length === 0) {
                        showMessage('warning', '请先加载索引字段信息');
                        return;
                    }
                    
                    const conditionsContainer = document.getElementById('conditionsContainer');
                    if (!conditionsContainer) return;
                    
                    // 清除提示信息
                    if (conditionsContainer.querySelector('.text-center')) {
                        conditionsContainer.innerHTML = '';
                    }
                    
                    // 生成唯一ID
                    const conditionId = 'condition_' + Date.now();
                    
                    // 创建条件行
                    const conditionRow = document.createElement('div');
                    conditionRow.className = 'condition-row mb-3 p-3 border rounded';
                    conditionRow.innerHTML = `
                        <div class="row align-items-end">
                            <div class="col-md-3">
                                <label class="form-label">字段</label>
                                <select class="field-select form-control" data-condition-id="${conditionId}">
                                    <option value="">请选择字段</option>
                                    ${indexFields.map(field => 
                                        `<option value="${escapeHtml(field.name)}" data-type="${field.type}">${escapeHtml(field.name)} (${field.type})</option>`
                                    ).join('')}
                                </select>
                            </div>
                            <div class="col-md-2">
                                <label class="form-label">查询类型</label>
                                <select class="condition-type-select form-control" data-condition-id="${conditionId}">
                                    <option value="eq">等于</option>
                                    <option value="like">模糊匹配</option>
                                    <option value="gt">大于</option>
                                    <option value="gte">大于等于</option>
                                    <option value="lt">小于</option>
                                    <option value="lte">小于等于</option>
                                    <option value="neq">不等于</option>
                                    <option value="in">包含</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">值</label>
                                <input type="text" class="condition-value form-control" placeholder="请输入值" data-condition-id="${conditionId}">
                            </div>
                            <div class="col-md-1">
                                <button type="button" class="btn btn-outline-danger delete-condition-btn">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                    `;
                    
                    conditionsContainer.appendChild(conditionRow);
                    
                    // 绑定字段选择事件
                    const fieldSelect = conditionRow.querySelector('.field-select');
                    fieldSelect.addEventListener('change', function() {
                        updateConditionTypeOptions(this);
                    });
                }
                
                // 根据字段类型更新条件类型选项
                function updateConditionTypeOptions(fieldSelect) {
                    const conditionId = fieldSelect.getAttribute('data-condition-id');
                    const typeSelect = document.querySelector(`.condition-type-select[data-condition-id="${conditionId}"]`);
                    const selectedOption = fieldSelect.options[fieldSelect.selectedIndex];
                    const fieldType = selectedOption ? selectedOption.getAttribute('data-type') : '';
                    
                    if (!typeSelect) return;
                    
                    // 清空所有选项
                    typeSelect.innerHTML = '';
                    
                    // 根据字段类型添加合适的查询类型
                    if (fieldType === 'text' || fieldType === 'keyword') {
                        // 文本类型
                        addOption(typeSelect, 'eq', '等于');
                        addOption(typeSelect, 'like', '模糊匹配');
                        addOption(typeSelect, 'neq', '不等于');
                        addOption(typeSelect, 'in', '包含');
                    } else if (fieldType === 'long' || fieldType === 'integer' || fieldType === 'short' || 
                               fieldType === 'double' || fieldType === 'float' || fieldType === 'half_float') {
                        // 数值类型
                        addOption(typeSelect, 'eq', '等于');
                        addOption(typeSelect, 'gt', '大于');
                        addOption(typeSelect, 'gte', '大于等于');
                        addOption(typeSelect, 'lt', '小于');
                        addOption(typeSelect, 'lte', '小于等于');
                        addOption(typeSelect, 'neq', '不等于');
                        addOption(typeSelect, 'in', '包含');
                    } else if (fieldType === 'date') {
                        // 日期类型
                        addOption(typeSelect, 'eq', '等于');
                        addOption(typeSelect, 'gt', '大于');
                        addOption(typeSelect, 'gte', '大于等于');
                        addOption(typeSelect, 'lt', '小于');
                        addOption(typeSelect, 'lte', '小于等于');
                        addOption(typeSelect, 'neq', '不等于');
                    } else if (fieldType === 'boolean') {
                        // 布尔类型
                        addOption(typeSelect, 'eq', '等于');
                        addOption(typeSelect, 'neq', '不等于');
                    } else {
                        // 其他类型
                        addOption(typeSelect, 'eq', '等于');
                        addOption(typeSelect, 'like', '模糊匹配');
                        addOption(typeSelect, 'neq', '不等于');
                        addOption(typeSelect, 'in', '包含');
                    }
                    
                    // 更新输入框类型
                    updateConditionInput(typeSelect);
                }
                
                // 添加选项到下拉列表
                function addOption(select, value, text) {
                    const option = document.createElement('option');
                    option.value = value;
                    option.textContent = text;
                    select.appendChild(option);
                }
                
                // 更新条件输入框
                function updateConditionInput(typeSelect) {
                    const conditionId = typeSelect.getAttribute('data-condition-id');
                    const valueInput = document.querySelector(`.condition-value[data-condition-id="${conditionId}"]`);
                    const fieldSelect = document.querySelector(`.field-select[data-condition-id="${conditionId}"]`);
                    const selectedOption = fieldSelect.options[fieldSelect.selectedIndex];
                    const fieldType = selectedOption ? selectedOption.getAttribute('data-type') : '';
                    const conditionType = typeSelect.value;
                    
                    if (!valueInput) return;
                    
                    // 重置输入框
                    valueInput.type = 'text';
                    valueInput.placeholder = '请输入值';
                    
                    // 根据条件类型和字段类型设置输入框
                    if (conditionType === 'in') {
                        valueInput.placeholder = '多个值用逗号分隔';
                    } else if (fieldType === 'boolean') {
                        // 替换为下拉选择
                        valueInput.type = 'text';
                        valueInput.placeholder = 'true 或 false';
                    } else if (fieldType === 'date') {
                        valueInput.placeholder = 'YYYY-MM-DD 或 YYYY-MM-DDTHH:mm:ss';
                    }
                }
                
                // 清空所有查询条件
                function clearAllConditions() {
                    const conditionsContainer = document.getElementById('conditionsContainer');
                    if (conditionsContainer) {
                        conditionsContainer.innerHTML = `
                            <div class="text-center text-muted py-3">
                                <i class="fas fa-list-ul mr-2"></i>暂无查询条件，请点击"添加条件"
                            </div>
                        `;
                    }
                }
                
                // 更新条件容器状态
                function updateConditionsContainerState() {
                    const conditionsContainer = document.getElementById('conditionsContainer');
                    if (conditionsContainer && conditionsContainer.querySelectorAll('.condition-row').length === 0) {
                        clearAllConditions();
                    }
                }
                
                // 执行动态查询
                function performDynamicSearch() {
                    const indexName = document.getElementById('dynamicIndexName').value.trim();
                    if (!indexName) {
                        showMessage('error', '请输入索引名称');
                        return;
                    }
                    
                    // 收集查询条件
                    const queryParams = {};
                    const conditionRows = document.querySelectorAll('.condition-row');
                    
                    // 即使没有条件也允许执行查询（无条件查询所有数据）
                    
                    let hasValidCondition = false;
                    
                    conditionRows.forEach(row => {
                        const fieldSelect = row.querySelector('.field-select');
                        const typeSelect = row.querySelector('.condition-type-select');
                        const valueInput = row.querySelector('.condition-value');
                        
                        const field = fieldSelect.value.trim();
                        const type = typeSelect.value;
                        const value = valueInput.value.trim();
                        
                        if (field && value) {
                            hasValidCondition = true;
                            
                            // 根据条件类型处理查询参数
                            switch (type) {
                                case 'like':
                                    // 模糊查询，在字段名后添加~或在值中添加通配符
                                    if (!value.includes('*') && !value.includes('?')) {
                                        queryParams[field + '~'] = '*' + value + '*';
                                    } else {
                                        queryParams[field] = value;
                                    }
                                    break;
                                case 'in':
                                    // 处理包含条件
                                    const values = value.split(',').map(v => v.trim()).filter(v => v);
                                    if (values.length > 0) {
                                        queryParams[field] = values;
                                    }
                                    break;
                                case 'eq':
                                case 'gt':
                                case 'gte':
                                case 'lt':
                                case 'lte':
                                case 'neq':
                                default:
                                    queryParams[field] = value;
                                    break;
                            }
                        }
                    });
                    
                    // 移除强制要求有效条件的验证，允许无条件查询
                    // 如果有条件行但都无效，仍然允许查询（将作为无条件查询处理）
                    
                    showLoading(true);
                    
                    const page = parseInt(document.getElementById('dynamicPage').value || '0');
                    const size = parseInt(document.getElementById('dynamicSize').value || '10');
                    
                    // 发送查询请求
                    fetch(`/api/es/dynamic-search?indexName=${encodeURIComponent(indexName)}&page=${page}&size=${size}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(queryParams)
                    })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('网络响应异常');
                        }
                        return response.json();
                    })
                    .then(data => {
                        showLoading(false);
                        if (data.success && Array.isArray(data.data)) {
                            renderDataList(data.data);
                            showMessage('success', `查询成功，共 ${data.data.length} 条记录`);
                        } else {
                            showMessage('error', data.message || '查询失败');
                            dataContainerElement.innerHTML = '<div class="text-center p-5">暂无数据</div>';
                        }
                    })
                    .catch(error => {
                        showLoading(false);
                        showMessage('error', '查询失败，请检查连接');
                        dataContainerElement.innerHTML = '<div class="text-center p-5">查询失败</div>';
                        console.error('执行动态查询时出错:', error);
                    });
                }
                
                // HTML转义函数
                function escapeHtml(text) {
                    const div = document.createElement('div');
                    div.textContent = text;
                    return div.innerHTML;
                }
            

            
            // 加载原始数据
            function loadRawData() {
                const indexName = rawIndexNameField.value.trim();
                const page = document.getElementById('rawPage').value;
                const size = document.getElementById('rawSize').value;
                
                if (!indexName) {
                    showMessage('error', '请输入索引名称');
                    return;
                }
                
                showLoading(true);
                
                let url = '/api/es/raw-search?indexName=' + encodeURIComponent(indexName);
                // 只有当page是有效数字且大于等于0时才添加
                if (page !== undefined && page !== '' && !isNaN(page) && parseInt(page) >= 0) {
                    url += '&page=' + encodeURIComponent(parseInt(page));
                }
                // 只有当size是有效数字且大于0时才添加
                if (size !== undefined && size !== '' && !isNaN(size) && parseInt(size) > 0) {
                    url += '&size=' + encodeURIComponent(parseInt(size));
                }
                
                fetch(url)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('网络响应异常');
                        }
                        return response.json();
                    })
                    .then(data => {
                        showLoading(false);
                        // 直接以JSON格式展示数据
                        if (data.data) {
                            // 创建一个包含复制按钮和JSON展示区的容器
                            const html = `
                                <div class="card">
                                    <div class="card-header d-flex justify-content-between align-items-center">
                                        <h6 class="mb-0">原始JSON数据</h6>
                                        <button id="copyRawJsonBtn" class="btn btn-sm btn-outline-primary">
                                            <i class="fa fa-copy mr-1"></i>复制JSON
                                        </button>
                                    </div>
                                    <div class="card-body p-0">
                                        <pre class="bg-dark text-white p-3 m-0 overflow-auto" style="max-height: 600px; white-space: pre-wrap;">
                                            ${JSON.stringify(data, null, 2).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')}
                                        </pre>
                                    </div>
                                </div>
                            `;
                            dataContainerElement.innerHTML = html;
                            
                            // 绑定复制按钮事件
                            document.getElementById('copyRawJsonBtn').addEventListener('click', function() {
                                const jsonText = JSON.stringify(data, null, 2);
                                navigator.clipboard.writeText(jsonText)
                                    .then(() => showMessage('success', 'JSON数据复制成功'))
                                    .catch(() => showMessage('error', '复制失败，请手动复制'));
                            });
                        } else {
                            showMessage('error', data.message || '查询失败');
                            dataContainerElement.innerHTML = '<div class="text-center p-5">暂无数据</div>';
                        }
                    })
                    .catch(error => {
                        showLoading(false);
                        showMessage('error', '查询失败，请检查连接');
                        dataContainerElement.innerHTML = '<div class="text-center p-5">查询失败</div>';
                        console.error('查询原始数据时出错:', error);
                    });
            }
            
            // 渲染数据列表
            function renderDataList(data) {
                if (!data || data.length === 0) {
                    dataContainerElement.innerHTML = '<div class="text-center p-5">暂无数据</div>';
                    return;
                }
                
                let html = '<table class="table table-striped table-hover"><thead><tr><th>索引</th><th>操作</th></tr></thead><tbody>';
                
                data.forEach(item => {
                    const safeItemJson = JSON.stringify(item).replace(/"/g, '&quot;');
                    const displayText = generateDisplayText(item);
                    html += '<tr><td>' + displayText + '</td><td><button class="btn btn-sm btn-info view-details-btn" data-item="' + safeItemJson + '">查看详情</button></td></tr>';
                });
                
                html += '</tbody></table>';
                dataContainerElement.innerHTML = html;
            }
            
            // 生成显示文本
            function generateDisplayText(item) {
                if (typeof item === 'object' && item !== null) {
                    // 尝试获取常用字段作为显示文本
                    const priorityFields = ['_id', 'id', 'name', 'title'];
                    for (const field of priorityFields) {
                        if (item[field]) {
                            const text = String(item[field]);
                            return text.length > 50 ? text.substring(0, 50) + '...' : text;
                        }
                    }
                    // 返回第一个属性值
                    const firstKey = Object.keys(item)[0];
                    return firstKey ? String(item[firstKey]).substring(0, 50) + '...' : '无数据';
                }
                return String(item);
            }
            
            // 显示数据详情
            function showDataDetails(itemJson) {
                try {
                    const item = JSON.parse(itemJson);
                    selectedDataItem = item;
                    
                    // 清空并生成详情内容
                    detailsContentElement.innerHTML = '';
                    
                    // 生成格式化的详情内容
                    Object.keys(item).forEach(key => {
                        const detailRow = document.createElement('div');
                        detailRow.className = 'mb-3';
                        detailRow.innerHTML = `<strong>${key}:</strong> <div>${formatDetailValue(item[key])}</div>`;
                        detailsContentElement.appendChild(detailRow);
                    });
                    
                    // 设置JSON内容
                    jsonContentElement.textContent = JSON.stringify(item, null, 2);
                    
                    // 显示模态框
                    const detailsModal = new bootstrap.Modal(detailsModalElement);
                    detailsModal.show();
                } catch (e) {
                    showMessage('error', '加载详情失败');
                    console.error('显示详情时出错:', e);
                }
            }
            
            // 格式化详情值
            function formatDetailValue(value) {
                if (value === null || value === undefined) return '-';
                if (typeof value === 'object') {
                    try {
                        return '<pre class="bg-light p-2 rounded">' + JSON.stringify(value, null, 2) + '</pre>';
                    } catch (e) {
                        return String(value);
                    }
                }
                if (typeof value === 'boolean') {
                    return value ? '是' : '否';
                }
                return String(value);
            }
            
            // 显示加载状态
            function showLoading(show) {
                loadingIndicator.style.display = show ? 'block' : 'none';
            }
            
            // 显示消息
            function showMessage(type, message) {
                // 移除所有现有消息
                messageContainerElement.innerHTML = '';
                
                // 创建新消息元素
                const messageElement = document.createElement('div');
                messageElement.className = `alert alert-${type} alert-dismissible fade show`;
                messageElement.innerHTML = message + '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="关闭"></button>';
                
                // 添加消息到容器
                messageContainerElement.appendChild(messageElement);
                
                // 3秒后自动隐藏
                setTimeout(() => {
                    messageElement.classList.remove('show');
                    setTimeout(() => messageElement.remove(), 500);
                }, 3000);
            }
            
            // 初始化应用
            initialize();
        });
    </script>
</body>
</html>