<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>智能聊天 - Spring AI Demo</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: #f8f9fa;
        }
        .navbar {
            background-color: #ffffff;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .sidebar {
            background-color: #ffffff;
            border-right: 1px solid #e9ecef;
            height: calc(100vh - 56px);
            overflow-y: auto;
        }
        .chat-container {
            height: calc(100vh - 56px);
            display: flex;
            flex-direction: column;
        }
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            background-color: #fafafa;
        }
        .message {
            margin-bottom: 1rem;
            display: flex;
            flex-direction: column;
        }
        .message.user {
            align-items: flex-end;
        }
        .message.ai {
            align-items: flex-start;
        }
        .message-content {
            max-width: 75%;
            padding: 0.75rem 1rem;
            border-radius: 1rem;
            word-wrap: break-word;
        }
        .message.user .message-content {
            background-color: #007bff;
            color: white;
        }
        .message.ai .message-content {
            background-color: #ffffff;
            border: 1px solid #e9ecef;
            color: #333;
        }
        .message-time {
            font-size: 0.75rem;
            color: #6c757d;
            margin-top: 0.25rem;
            padding: 0 0.5rem;
        }
        .chat-input {
            padding: 1rem;
            background-color: #ffffff;
            border-top: 1px solid #e9ecef;
        }
        .conversation-item {
            padding: 0.75rem 1rem;
            cursor: pointer;
            transition: background-color 0.2s;
            border-bottom: 1px solid #f1f3f4;
        }
        .conversation-item:hover {
            background-color: #f8f9fa;
        }
        .conversation-item.active {
            background-color: #e7f3ff;
            border-left: 3px solid #007bff;
        }
        .badge-unread {
            background-color: #dc3545;
            font-size: 0.7rem;
            padding: 0.25rem 0.5rem;
        }
        .typing-indicator {
            display: inline-flex;
            align-items: center;
            padding: 0.75rem 1rem;
            background-color: #ffffff;
            border: 1px solid #e9ecef;
            border-radius: 1rem;
            max-width: 75%;
        }
        .typing-indicator span {
            height: 8px;
            width: 8px;
            margin: 0 2px;
            background-color: #007bff;
            border-radius: 50%;
            display: inline-block;
            animation: typing 1.4s infinite ease-in-out both;
        }
        .typing-indicator span:nth-child(1) {
            animation-delay: -0.32s;
        }
        .typing-indicator span:nth-child(2) {
            animation-delay: -0.16s;
        }
        @keyframes typing {
            0%, 80%, 100% { 
                transform: scale(0);
            }
            40% { 
                transform: scale(1.0);
            }
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-light sticky-top">
        <div class="container-fluid">
            <a class="navbar-brand d-flex align-items-center" href="/">
                <i class="fas fa-robot text-primary me-2"></i>
                <span class="fw-bold text-dark">Spring AI Demo</span>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/">
                            <i class="fas fa-tachometer-alt me-1"></i> 仪表板
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/chat">
                            <i class="fas fa-comment-dots me-1"></i> 智能聊天
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/code">
                            <i class="fas fa-code me-1"></i> 代码工具
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/content">
                            <i class="fas fa-file-alt me-1"></i> 内容处理
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/utility">
                            <i class="fas fa-tools me-1"></i> 实用工具
                        </a>
                    </li>
                </ul>
                <div class="d-flex align-items-center">
                    <div class="text-sm text-muted mr-3">
                        <span id="connection-status" class="badge bg-success">已连接</span>
                    </div>
                    <button class="btn btn-outline-primary" id="theme-toggle">
                        <i class="fas fa-moon"></i>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <div class="container-fluid">
        <div class="row">
            <!-- 会话列表侧边栏 -->
            <div class="col-md-3 sidebar">
                <div class="p-3 border-bottom">
                    <button class="btn btn-primary w-100 d-flex justify-content-center align-items-center" id="new-conversation">
                        <i class="fas fa-plus mr-2"></i> 新建对话
                    </button>
                </div>
                <div class="p-3 border-bottom">
                    <div class="input-group">
                        <input type="text" class="form-control form-control-sm" placeholder="搜索对话..." id="search-conversations">
                        <button class="btn btn-outline-secondary btn-sm">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </div>
                <div id="conversation-list">
                    <!-- 会话列表将通过JavaScript动态填充 -->
                </div>
            </div>

            <!-- 聊天主界面 -->
            <div class="col-md-9 chat-container">
                <div class="chat-messages" id="chat-messages">
                    <!-- 欢迎消息 -->
                    <div class="message ai">
                        <div class="message-content">
                            <p>你好！我是AI助手，很高兴为你服务。</p>
                            <p>我可以帮助你：</p>
                            <ul>
                                <li>回答各种问题</li>
                                <li>生成和解释代码</li>
                                <li>总结和分析文本</li>
                                <li>创建文档和学习计划</li>
                            </ul>
                            <p>请输入你的问题开始对话！</p>
                        </div>
                        <div class="message-time">刚刚</div>
                    </div>
                </div>
                
                <!-- 聊天输入区域 -->
                <div class="chat-input">
                    <div class="input-group">
                        <select id="message-style" class="form-select form-select-sm w-auto me-2">
                            <option value="normal">普通</option>
                            <option value="professional">专业</option>
                            <option value="casual">休闲</option>
                            <option value="creative">创意</option>
                        </select>
                        <textarea id="message-input" class="form-control" rows="2" placeholder="输入你的消息..."></textarea>
                        <div class="input-group-append">
                            <button class="btn btn-primary" id="send-message">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 模态框：新建对话 -->
    <div class="modal fade" id="newConversationModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">新建对话</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="conversation-name" class="form-label">对话名称</label>
                        <input type="text" class="form-control" id="conversation-name" placeholder="例如：项目规划讨论">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">对话类型</label>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="conversation-type" id="type-general" checked>
                            <label class="form-check-label" for="type-general">
                                普通对话
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="conversation-type" id="type-code">
                            <label class="form-check-label" for="type-code">
                                代码相关
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="conversation-type" id="type-content">
                            <label class="form-check-label" for="type-content">
                                内容创作
                            </label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="confirm-new-conversation">创建</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 模态框：会话操作 -->
    <div class="modal fade" id="conversationActionsModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-sm">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">会话操作</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <button class="btn btn-outline-primary w-100 mb-2" id="rename-conversation">
                        <i class="fas fa-edit mr-2"></i> 重命名会话
                    </button>
                    <button class="btn btn-outline-secondary w-100 mb-2" id="export-conversation">
                        <i class="fas fa-file-export mr-2"></i> 导出对话
                    </button>
                    <button class="btn btn-outline-secondary w-100 mb-2" id="clear-conversation">
                        <i class="fas fa-eraser mr-2"></i> 清空消息
                    </button>
                    <button class="btn btn-outline-danger w-100" id="delete-conversation">
                        <i class="fas fa-trash-alt mr-2"></i> 删除会话
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 模态框：重命名会话 -->
    <div class="modal fade" id="renameConversationModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">重命名会话</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="new-conversation-name" class="form-label">新名称</label>
                        <input type="text" class="form-control" id="new-conversation-name" placeholder="输入新的会话名称">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="confirm-rename">确认</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 当前活动的会话ID
        let currentConversationId = 'default';
        let conversations = [];
        
        // 页面加载时初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 加载会话列表
            loadConversations();
            
            // 发送消息按钮点击事件
            document.getElementById('send-message').addEventListener('click', sendMessage);
            
            // 输入框回车发送（Shift+回车换行）
            document.getElementById('message-input').addEventListener('keydown', function(event) {
                if (event.key === 'Enter' && !event.shiftKey) {
                    event.preventDefault();
                    sendMessage();
                }
            });
            
            // 新建对话按钮
            document.getElementById('new-conversation').addEventListener('click', function() {
                document.getElementById('newConversationModal').classList.add('show');
                document.getElementById('newConversationModal').style.display = 'block';
            });
            
            // 确认新建对话
            document.getElementById('confirm-new-conversation').addEventListener('click', createNewConversation);
            
            // 会话操作相关事件绑定
            document.getElementById('rename-conversation').addEventListener('click', openRenameModal);
            document.getElementById('confirm-rename').addEventListener('click', renameConversation);
            document.getElementById('delete-conversation').addEventListener('click', deleteConversation);
            document.getElementById('clear-conversation').addEventListener('click', clearConversation);
            document.getElementById('export-conversation').addEventListener('click', exportConversation);
            
            // 搜索会话
            document.getElementById('search-conversations').addEventListener('input', searchConversations);
        });
        
        // 加载会话列表
        function loadConversations() {
            // 这里应该从服务器获取会话列表，暂时使用模拟数据
            conversations = [
                { id: 'default', name: '新对话', date: new Date(), unread: 0 },
                { id: 'conv1', name: '项目规划讨论', date: new Date(Date.now() - 86400000), unread: 0 },
                { id: 'conv2', name: 'Java代码优化', date: new Date(Date.now() - 172800000), unread: 2 }
            ];
            
            renderConversationList();
        }
        
        // 渲染会话列表
        function renderConversationList() {
            const listContainer = document.getElementById('conversation-list');
            listContainer.innerHTML = '';
            
            conversations.forEach(conv => {
                const convItem = document.createElement('div');
                convItem.className = `conversation-item ${conv.id === currentConversationId ? 'active' : ''}`;
                convItem.dataset.id = conv.id;
                
                const dateStr = new Date(conv.date).toLocaleDateString();
                
                convItem.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">${conv.name}</h6>
                        ${conv.unread > 0 ? `<span class="badge badge-unread">${conv.unread}</span>` : ''}
                    </div>
                    <div class="text-xs text-muted">${dateStr}</div>
                `;
                
                // 点击切换会话
                convItem.addEventListener('click', function(e) {
                    // 如果点击的是...按钮，则不切换会话
                    if (e.target.closest('.dropdown-toggle')) return;
                    
                    // 清除当前活动会话的active类
                    const activeItem = document.querySelector('.conversation-item.active');
                    if (activeItem) activeItem.classList.remove('active');
                    
                    // 设置新的活动会话
                    convItem.classList.add('active');
                    currentConversationId = conv.id;
                    
                    // 加载会话内容
                    loadConversationContent();
                });
                
                // 右键点击显示会话操作
                convItem.addEventListener('contextmenu', function(e) {
                    e.preventDefault();
                    document.getElementById('conversationActionsModal').classList.add('show');
                    document.getElementById('conversationActionsModal').style.display = 'block';
                });
                
                listContainer.appendChild(convItem);
            });
        }
        
        // 加载会话内容
        function loadConversationContent() {
            const messagesContainer = document.getElementById('chat-messages');
            // 模拟加载不同会话的内容
            if (currentConversationId === 'default') {
                messagesContainer.innerHTML = `
                    <div class="message ai">
                        <div class="message-content">
                            <p>你好！我是AI助手，很高兴为你服务。</p>
                            <p>我可以帮助你：</p>
                            <ul>
                                <li>回答各种问题</li>
                                <li>生成和解释代码</li>
                                <li>总结和分析文本</li>
                                <li>创建文档和学习计划</li>
                            </ul>
                            <p>请输入你的问题开始对话！</p>
                        </div>
                        <div class="message-time">刚刚</div>
                    </div>
                `;
            } else {
                // 这里应该从服务器加载历史消息
                messagesContainer.innerHTML = `
                    <div class="message ai">
                        <div class="message-content">
                            <p>这是历史会话 ${currentConversationId} 的内容。</p>
                            <p>这里会显示该会话的历史消息记录。</p>
                        </div>
                        <div class="message-time">昨天</div>
                    </div>
                `;
            }
            
            // 滚动到底部
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }
        
        // 发送消息
        function sendMessage() {
            const messageInput = document.getElementById('message-input');
            const message = messageInput.value.trim();
            
            if (!message) return;
            
            // 获取消息风格
            const messageStyle = document.getElementById('message-style').value;
            
            // 添加用户消息到界面
            const messagesContainer = document.getElementById('chat-messages');
            const now = new Date();
            
            const userMessageHtml = `
                <div class="message user">
                    <div class="message-content">${escapeHtml(message)}</div>
                    <div class="message-time">${now.toLocaleTimeString()}</div>
                </div>
            `;
            messagesContainer.insertAdjacentHTML('beforeend', userMessageHtml);
            
            // 清空输入框
            messageInput.value = '';
            
            // 滚动到底部
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            // 显示AI正在输入的状态
            const typingIndicator = `
                <div class="message ai" id="typing-indicator">
                    <div class="typing-indicator">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                </div>
            `;
            messagesContainer.insertAdjacentHTML('beforeend', typingIndicator);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            // 发送请求到服务器
            fetch('/api/chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    conversationId: currentConversationId,
                    content: message,
                    style: messageStyle
                })
            })
            .then(response => response.json())
            .then(data => {
                // 移除输入指示器
                const typingElement = document.getElementById('typing-indicator');
                if (typingElement) typingElement.remove();
                
                // 添加AI回复到界面
                const aiMessageHtml = `
                    <div class="message ai">
                        <div class="message-content">${formatResponse(data.response)}</div>
                        <div class="message-time">${new Date().toLocaleTimeString()}</div>
                    </div>
                `;
                messagesContainer.insertAdjacentHTML('beforeend', aiMessageHtml);
                
                // 滚动到底部
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            })
            .catch(error => {
                console.error('Error:', error);
                
                // 移除输入指示器
                const typingElement = document.getElementById('typing-indicator');
                if (typingElement) typingElement.remove();
                
                // 显示错误消息
                const errorMessageHtml = `
                    <div class="message ai">
                        <div class="message-content">
                            <p class="text-danger">发送请求失败，请稍后重试。</p>
                            <p class="text-sm">错误信息: ${error.message || '未知错误'}</p>
                        </div>
                        <div class="message-time">${new Date().toLocaleTimeString()}</div>
                    </div>
                `;
                messagesContainer.insertAdjacentHTML('beforeend', errorMessageHtml);
                
                // 滚动到底部
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            });
        }
        
        // 创建新对话
        function createNewConversation() {
            const nameInput = document.getElementById('conversation-name');
            const conversationName = nameInput.value.trim() || `新对话 ${conversations.length + 1}`;
            
            // 这里应该调用API创建新对话
            const newConvId = 'conv' + Date.now();
            
            conversations.unshift({
                id: newConvId,
                name: conversationName,
                date: new Date(),
                unread: 0
            });
            
            // 关闭模态框
            document.getElementById('newConversationModal').classList.remove('show');
            document.getElementById('newConversationModal').style.display = 'none';
            
            // 重置输入框
            nameInput.value = '';
            
            // 更新会话列表
            renderConversationList();
            
            // 切换到新会话
            currentConversationId = newConvId;
            loadConversationContent();
        }
        
        // 打开重命名模态框
        function openRenameModal() {
            const activeConv = conversations.find(conv => conv.id === currentConversationId);
            if (activeConv) {
                document.getElementById('new-conversation-name').value = activeConv.name;
                document.getElementById('renameConversationModal').classList.add('show');
                document.getElementById('renameConversationModal').style.display = 'block';
            }
            
            // 关闭会话操作模态框
            document.getElementById('conversationActionsModal').classList.remove('show');
            document.getElementById('conversationActionsModal').style.display = 'none';
        }
        
        // 重命名会话
        function renameConversation() {
            const newName = document.getElementById('new-conversation-name').value.trim();
            if (!newName) return;
            
            const convIndex = conversations.findIndex(conv => conv.id === currentConversationId);
            if (convIndex !== -1) {
                conversations[convIndex].name = newName;
                
                // 这里应该调用API更新会话名称
                
                // 更新会话列表
                renderConversationList();
            }
            
            // 关闭模态框
            document.getElementById('renameConversationModal').classList.remove('show');
            document.getElementById('renameConversationModal').style.display = 'none';
        }
        
        // 删除会话
        function deleteConversation() {
            if (confirm('确定要删除这个会话吗？所有消息将被永久删除。')) {
                const convIndex = conversations.findIndex(conv => conv.id === currentConversationId);
                if (convIndex !== -1) {
                    // 这里应该调用API删除会话
                    
                    conversations.splice(convIndex, 1);
                    
                    // 如果删除的是当前会话，切换到第一个会话
                    if (conversations.length > 0) {
                        currentConversationId = conversations[0].id;
                        loadConversationContent();
                    } else {
                        // 如果没有会话了，创建一个默认会话
                        createNewConversation();
                    }
                    
                    // 更新会话列表
                    renderConversationList();
                }
            }
            
            // 关闭模态框
            document.getElementById('conversationActionsModal').classList.remove('show');
            document.getElementById('conversationActionsModal').style.display = 'none';
        }
        
        // 清空会话
        function clearConversation() {
            if (confirm('确定要清空这个会话的所有消息吗？')) {
                // 这里应该调用API清空会话
                
                // 清空当前显示的消息
                document.getElementById('chat-messages').innerHTML = `
                    <div class="message ai">
                        <div class="message-content">
                            <p>会话已清空。</p>
                            <p>你可以继续输入新的消息开始对话。</p>
                        </div>
                        <div class="message-time">刚刚</div>
                    </div>
                `;
            }
            
            // 关闭模态框
            document.getElementById('conversationActionsModal').classList.remove('show');
            document.getElementById('conversationActionsModal').style.display = 'none';
        }
        
        // 导出会话
        function exportConversation() {
            // 这里应该调用API导出会话
            alert('导出功能正在开发中...');
            
            // 关闭模态框
            document.getElementById('conversationActionsModal').classList.remove('show');
            document.getElementById('conversationActionsModal').style.display = 'none';
        }
        
        // 搜索会话
        function searchConversations() {
            const searchTerm = document.getElementById('search-conversations').value.toLowerCase();
            
            const filteredConversations = conversations.filter(conv => 
                conv.name.toLowerCase().includes(searchTerm)
            );
            
            const listContainer = document.getElementById('conversation-list');
            listContainer.innerHTML = '';
            
            filteredConversations.forEach(conv => {
                const convItem = document.createElement('div');
                convItem.className = `conversation-item ${conv.id === currentConversationId ? 'active' : ''}`;
                convItem.dataset.id = conv.id;
                
                const dateStr = new Date(conv.date).toLocaleDateString();
                
                convItem.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">${conv.name}</h6>
                        ${conv.unread > 0 ? `<span class="badge badge-unread">${conv.unread}</span>` : ''}
                    </div>
                    <div class="text-xs text-muted">${dateStr}</div>
                `;
                
                // 点击切换会话
                convItem.addEventListener('click', function() {
                    // 清除当前活动会话的active类
                    const activeItem = document.querySelector('.conversation-item.active');
                    if (activeItem) activeItem.classList.remove('active');
                    
                    // 设置新的活动会话
                    convItem.classList.add('active');
                    currentConversationId = conv.id;
                    
                    // 加载会话内容
                    loadConversationContent();
                });
                
                listContainer.appendChild(convItem);
            });
        }
        
        // 工具函数：转义HTML特殊字符
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // 工具函数：格式化响应内容
        function formatResponse(response) {
            // 将markdown格式转换为HTML
            let formatted = response
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/`(.*?)`/g, '<code>$1</code>')
                .replace(/\n/g, '<br>');
            
            return formatted;
        }
    </script>
</body>
</html>