<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>代码工具 - Spring AI Demo</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.4/ace.js"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: #f8f9fa;
        }
        .navbar {
            background-color: #ffffff;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .card {
            border-radius: 0.5rem;
            border: 1px solid #e9ecef;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .card-header {
            background-color: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }
        .tab-content {
            border: 1px solid #e9ecef;
            border-top: none;
            border-radius: 0 0 0.5rem 0.5rem;
        }
        .code-editor {
            height: 400px;
            border-radius: 0.25rem;
        }
        .preview-container {
            background-color: #f8f9fa;
            min-height: 400px;
            border-radius: 0.25rem;
            overflow-x: auto;
        }
        .preview-content {
            padding: 1rem;
        }
        .code-block {
            background-color: #f6f8fa;
            border-radius: 0.25rem;
            padding: 1rem;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 0.875rem;
            line-height: 1.5;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .step {
            background-color: #e7f3ff;
            padding: 1rem;
            border-radius: 0.25rem;
            margin-bottom: 1rem;
        }
        .step-header {
            font-weight: bold;
            color: #0056b3;
            margin-bottom: 0.5rem;
        }
        .success-alert {
            background-color: #d4edda;
            color: #155724;
            border-color: #c3e6cb;
        }
        .error-alert {
            background-color: #f8d7da;
            color: #721c24;
            border-color: #f5c6cb;
        }
        .language-select {
            max-width: 200px;
        }
        .btn-group-toggle .btn.active {
            background-color: #007bff;
            color: white;
            border-color: #007bff;
        }
        .loader {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-light sticky-top">
        <div class="container-fluid">
            <a class="navbar-brand d-flex align-items-center" href="/">
                <i class="fas fa-robot text-primary me-2"></i>
                <span class="fw-bold text-dark">Spring AI Demo</span>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="/">
                            <i class="fas fa-tachometer-alt me-1"></i> 仪表板
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/chat">
                            <i class="fas fa-comment-dots me-1"></i> 智能聊天
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/code">
                            <i class="fas fa-code me-1"></i> 代码工具
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/content">
                            <i class="fas fa-file-alt me-1"></i> 内容处理
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/utility">
                            <i class="fas fa-tools me-1"></i> 实用工具
                        </a>
                    </li>
                </ul>
                <div class="d-flex align-items-center">
                    <div class="text-sm text-muted mr-3">
                        <span id="connection-status" class="badge bg-success">已连接</span>
                    </div>
                    <button class="btn btn-outline-primary" id="theme-toggle">
                        <i class="fas fa-moon"></i>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <div class="container-fluid py-4">
        <div class="row">
            <div class="col-12">
                <h1 class="mb-4">代码工具</h1>
                <p class="text-muted mb-5">使用AI能力帮助您生成、解释和审查代码，提升开发效率。</p>
            </div>
        </div>

        <!-- 功能选项卡 -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="btn-group btn-group-toggle" data-toggle="buttons">
                    <label class="btn btn-outline-secondary active" id="tab-generate">
                        <input type="radio" name="tabs" checked autocomplete="off">
                        <i class="fas fa-code-branch mr-2"></i> 代码生成
                    </label>
                    <label class="btn btn-outline-secondary" id="tab-explain">
                        <input type="radio" name="tabs" autocomplete="off">
                        <i class="fas fa-book-open mr-2"></i> 代码解释
                    </label>
                    <label class="btn btn-outline-secondary" id="tab-review">
                        <input type="radio" name="tabs" autocomplete="off">
                        <i class="fas fa-search mr-2"></i> 代码审查
                    </label>
                </div>
            </div>
        </div>

        <!-- 主要内容区域 -->
        <div class="row">
            <!-- 左侧输入区域 -->
            <div class="col-lg-6">
                <!-- 代码生成区域 -->
                <div class="tab-pane fade show active" id="generate-tab">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">代码生成</h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label for="generate-language" class="form-label">编程语言</label>
                                <select class="form-select language-select" id="generate-language">
                                    <option value="java">Java</option>
                                    <option value="python">Python</option>
                                    <option value="javascript">JavaScript</option>
                                    <option value="typescript">TypeScript</option>
                                    <option value="csharp">C#</option>
                                    <option value="cpp">C++</option>
                                    <option value="go">Go</option>
                                    <option value="rust">Rust</option>
                                    <option value="kotlin">Kotlin</option>
                                    <option value="swift">Swift</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="generate-prompt" class="form-label">描述您需要的代码功能</label>
                                <textarea class="form-control" id="generate-prompt" rows="6" placeholder="例如：编写一个Java方法，实现快速排序算法，要求有详细的注释..."></textarea>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">代码要求</label>
                                <div class="form-check">
                                    <input type="checkbox" class="form-check-input" id="require-comments" checked>
                                    <label class="form-check-label" for="require-comments">包含详细注释</label>
                                </div>
                                <div class="form-check">
                                    <input type="checkbox" class="form-check-input" id="require-error-handling">
                                    <label class="form-check-label" for="require-error-handling">包含异常处理</label>
                                </div>
                                <div class="form-check">
                                    <input type="checkbox" class="form-check-input" id="require-test-cases">
                                    <label class="form-check-label" for="require-test-cases">包含测试用例</label>
                                </div>
                            </div>
                            <button class="btn btn-primary w-100" id="generate-code-btn">
                                <i class="fas fa-magic mr-2"></i>
                                <span>生成代码</span>
                                <span class="loader" id="generate-loader" style="display: none;"></span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- 代码解释区域 -->
                <div class="tab-pane fade" id="explain-tab">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">代码解释</h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label for="explain-language" class="form-label">编程语言</label>
                                <select class="form-select language-select" id="explain-language">
                                    <option value="java">Java</option>
                                    <option value="python">Python</option>
                                    <option value="javascript">JavaScript</option>
                                    <option value="typescript">TypeScript</option>
                                    <option value="csharp">C#</option>
                                    <option value="cpp">C++</option>
                                    <option value="go">Go</option>
                                    <option value="rust">Rust</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="explain-code" class="form-label">请输入需要解释的代码</label>
                                <textarea class="form-control" id="explain-code" rows="10" placeholder="粘贴您需要解释的代码..."></textarea>
                            </div>
                            <div class="mb-3">
                                <label for="explain-focus" class="form-label">解释重点</label>
                                <select class="form-select" id="explain-focus">
                                    <option value="all">整体功能和逻辑</option>
                                    <option value="algorithm">算法和数据结构</option>
                                    <option value="optimization">性能优化</option>
                                    <option value="security">安全性问题</option>
                                    <option value="best-practices">最佳实践</option>
                                </select>
                            </div>
                            <button class="btn btn-primary w-100" id="explain-code-btn">
                                <i class="fas fa-book-open mr-2"></i>
                                <span>解释代码</span>
                                <span class="loader" id="explain-loader" style="display: none;"></span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- 代码审查区域 -->
                <div class="tab-pane fade" id="review-tab">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">代码审查</h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label for="review-language" class="form-label">编程语言</label>
                                <select class="form-select language-select" id="review-language">
                                    <option value="java">Java</option>
                                    <option value="python">Python</option>
                                    <option value="javascript">JavaScript</option>
                                    <option value="typescript">TypeScript</option>
                                    <option value="csharp">C#</option>
                                    <option value="cpp">C++</option>
                                    <option value="go">Go</option>
                                    <option value="rust">Rust</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="review-code" class="form-label">请输入需要审查的代码</label>
                                <textarea class="form-control" id="review-code" rows="10" placeholder="粘贴您需要审查的代码..."></textarea>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">审查重点</label>
                                <div class="form-check">
                                    <input type="checkbox" class="form-check-input" id="check-performance" checked>
                                    <label class="form-check-label" for="check-performance">性能优化建议</label>
                                </div>
                                <div class="form-check">
                                    <input type="checkbox" class="form-check-input" id="check-security" checked>
                                    <label class="form-check-label" for="check-security">安全性检查</label>
                                </div>
                                <div class="form-check">
                                    <input type="checkbox" class="form-check-input" id="check-best-practices" checked>
                                    <label class="form-check-label" for="check-best-practices">最佳实践建议</label>
                                </div>
                                <div class="form-check">
                                    <input type="checkbox" class="form-check-input" id="check-bugs">
                                    <label class="form-check-label" for="check-bugs">潜在bug检测</label>
                                </div>
                            </div>
                            <button class="btn btn-primary w-100" id="review-code-btn">
                                <i class="fas fa-search mr-2"></i>
                                <span>审查代码</span>
                                <span class="loader" id="review-loader" style="display: none;"></span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 右侧结果区域 -->
            <div class="col-lg-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">结果</h5>
                    </div>
                    <div class="card-body">
                        <div id="result-container" class="preview-container">
                            <div class="preview-content">
                                <div class="text-center py-5" id="empty-result">
                                    <i class="fas fa-code text-muted mb-3" style="font-size: 4rem;"></i>
                                    <h4 class="text-muted">等待生成结果</h4>
                                    <p class="text-sm text-muted">请完成左侧表单并点击相应按钮开始处理</p>
                                </div>
                                
                                <!-- 代码生成结果将显示在这里 -->
                                <div id="generated-code-result" style="display: none;">
                                    <div class="mb-3">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <h6 class="mb-0">生成的代码</h6>
                                            <div class="btn-group">
                                                <button class="btn btn-sm btn-outline-secondary" id="copy-generated-code">
                                                    <i class="fas fa-copy"></i> 复制
                                                </button>
                                                <button class="btn btn-sm btn-outline-secondary" id="download-generated-code">
                                                    <i class="fas fa-download"></i> 下载
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    <pre><code id="generated-code-output" class="language-java"></code></pre>
                                    <div class="mt-3" id="generated-code-explanation"></div>
                                </div>
                                
                                <!-- 代码解释结果将显示在这里 -->
                                <div id="explained-code-result" style="display: none;">
                                    <h6 class="mb-3">代码解释</h6>
                                    <div id="explained-code-content"></div>
                                </div>
                                
                                <!-- 代码审查结果将显示在这里 -->
                                <div id="reviewed-code-result" style="display: none;">
                                    <h6 class="mb-3">代码审查报告</h6>
                                    
                                    <div class="mb-4">
                                        <div class="d-flex justify-content-between mb-2">
                                            <span class="font-weight-bold">总体评价:</span>
                                            <span id="review-overall" class="badge bg-success">良好</span>
                                        </div>
                                        <div class="progress" style="height: 10px;">
                                            <div id="review-progress-bar" class="progress-bar bg-success" role="progressbar" style="width: 85%" aria-valuenow="85" aria-valuemin="0" aria-valuemax="100"></div>
                                        </div>
                                    </div>
                                    
                                    <div id="review-performance-section" class="mb-3">
                                        <h7 class="font-weight-bold text-primary mb-2">性能优化建议:</h7>
                                        <div class="pl-3" id="review-performance-content"></div>
                                    </div>
                                    
                                    <div id="review-security-section" class="mb-3">
                                        <h7 class="font-weight-bold text-danger mb-2">安全性问题:</h7>
                                        <div class="pl-3" id="review-security-content"></div>
                                    </div>
                                    
                                    <div id="review-practices-section" class="mb-3">
                                        <h7 class="font-weight-bold text-info mb-2">最佳实践建议:</h7>
                                        <div class="pl-3" id="review-practices-content"></div>
                                    </div>
                                    
                                    <div id="review-bugs-section" class="mb-3">
                                        <h7 class="font-weight-bold text-warning mb-2">潜在Bug:</h7>
                                        <div class="pl-3" id="review-bugs-content"></div>
                                    </div>
                                    
                                    <div class="mt-4">
                                        <h7 class="font-weight-bold mb-2">改进后的代码:</h7>
                                        <pre><code id="review-improved-code" class="language-java"></code></pre>
                                    </div>
                                </div>
                                
                                <!-- 错误信息将显示在这里 -->
                                <div id="error-message" class="alert error-alert" style="display: none;">
                                    <i class="fas fa-exclamation-circle mr-2"></i>
                                    <span id="error-text">处理过程中发生错误，请稍后重试。</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 常用代码模板区域 -->
        <div class="row mt-5">
            <div class="col-12">
                <h3 class="mb-3">常用代码模板</h3>
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <div class="card h-100">
                            <div class="card-body">
                                <h6 class="card-title">Java快速排序</h6>
                                <p class="card-text text-sm">经典的快速排序算法实现，包含详细注释。</p>
                                <button class="btn btn-sm btn-outline-primary load-template" data-template="quick-sort">加载模板</button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <div class="card h-100">
                            <div class="card-body">
                                <h6 class="card-title">Python数据处理</h6>
                                <p class="card-text text-sm">使用Pandas进行数据分析和处理的常用操作。</p>
                                <button class="btn btn-sm btn-outline-primary load-template" data-template="data-analysis">加载模板</button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <div class="card h-100">
                            <div class="card-body">
                                <h6 class="card-title">JavaScript异步操作</h6>
                                <p class="card-text text-sm">使用Promise和async/await处理异步操作。</p>
                                <button class="btn btn-sm btn-outline-primary load-template" data-template="async-js">加载模板</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 页面加载后初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 初始化标签切换功能
            document.getElementById('tab-generate').addEventListener('click', function() {
                showTab('generate');
            });
            document.getElementById('tab-explain').addEventListener('click', function() {
                showTab('explain');
            });
            document.getElementById('tab-review').addEventListener('click', function() {
                showTab('review');
            });
            
            // 初始化按钮事件
            document.getElementById('generate-code-btn').addEventListener('click', generateCode);
            document.getElementById('explain-code-btn').addEventListener('click', explainCode);
            document.getElementById('review-code-btn').addEventListener('click', reviewCode);
            
            // 复制和下载功能
            document.getElementById('copy-generated-code').addEventListener('click', copyGeneratedCode);
            document.getElementById('download-generated-code').addEventListener('click', downloadGeneratedCode);
            
            // 代码模板加载
            document.querySelectorAll('.load-template').forEach(button => {
                button.addEventListener('click', function() {
                    loadTemplate(this.dataset.template);
                });
            });
        });
        
        // 切换标签
        function showTab(tabName) {
            // 重置所有标签样式
            document.getElementById('tab-generate').classList.remove('active');
            document.getElementById('tab-explain').classList.remove('active');
            document.getElementById('tab-review').classList.remove('active');
            
            // 隐藏所有标签内容
            document.getElementById('generate-tab').classList.remove('show', 'active');
            document.getElementById('explain-tab').classList.remove('show', 'active');
            document.getElementById('review-tab').classList.remove('show', 'active');
            
            // 显示选中的标签
            document.getElementById(`tab-${tabName}`).classList.add('active');
            document.getElementById(`${tabName}-tab`).classList.add('show', 'active');
            
            // 重置结果区域
            resetResultArea();
        }
        
        // 重置结果区域
        function resetResultArea() {
            document.getElementById('empty-result').style.display = 'block';
            document.getElementById('generated-code-result').style.display = 'none';
            document.getElementById('explained-code-result').style.display = 'none';
            document.getElementById('reviewed-code-result').style.display = 'none';
            document.getElementById('error-message').style.display = 'none';
        }
        
        // 显示加载状态
        function showLoading(loaderId) {
            document.getElementById(loaderId).style.display = 'inline-block';
        }
        
        // 隐藏加载状态
        function hideLoading(loaderId) {
            document.getElementById(loaderId).style.display = 'none';
        }
        
        // 显示错误消息
        function showError(message) {
            resetResultArea();
            document.getElementById('error-text').textContent = message;
            document.getElementById('error-message').style.display = 'block';
        }
        
        // 生成代码
        function generateCode() {
            const language = document.getElementById('generate-language').value;
            const prompt = document.getElementById('generate-prompt').value.trim();
            
            if (!prompt) {
                showError('请输入代码功能描述');
                return;
            }
            
            // 构建请求参数
            const requestData = {
                action: 'generate',
                language: language,
                prompt: prompt,
                requireComments: document.getElementById('require-comments').checked,
                requireErrorHandling: document.getElementById('require-error-handling').checked,
                requireTestCases: document.getElementById('require-test-cases').checked
            };
            
            // 显示加载状态
            showLoading('generate-loader');
            
            // 发送请求
            fetch('/api/code', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestData)
            })
            .then(response => response.json())
            .then(data => {
                hideLoading('generate-loader');
                
                if (data.success) {
                    // 显示生成的代码
                    resetResultArea();
                    document.getElementById('generated-code-result').style.display = 'block';
                    
                    const codeOutput = document.getElementById('generated-code-output');
                    codeOutput.textContent = data.result;
                    codeOutput.className = `language-${language}`;
                    
                    // 高亮代码
                    hljs.highlightElement(codeOutput);
                    
                    // 添加代码解释
                    if (data.explanation) {
                        document.getElementById('generated-code-explanation').innerHTML = `
                            <div class="mt-3 pt-3 border-top">
                                <h6 class="mb-2">代码解释:</h6>
                                <p>${data.explanation}</p>
                            </div>
                        `;
                    }
                } else {
                    showError(data.error || '代码生成失败，请稍后重试');
                }
            })
            .catch(error => {
                hideLoading('generate-loader');
                showError('请求失败: ' + error.message);
            });
        }
        
        // 解释代码
        function explainCode() {
            const language = document.getElementById('explain-language').value;
            const code = document.getElementById('explain-code').value.trim();
            const focus = document.getElementById('explain-focus').value;
            
            if (!code) {
                showError('请输入需要解释的代码');
                return;
            }
            
            // 构建请求参数
            const requestData = {
                action: 'explain',
                language: language,
                code: code,
                focus: focus
            };
            
            // 显示加载状态
            showLoading('explain-loader');
            
            // 发送请求
            fetch('/api/code', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestData)
            })
            .then(response => response.json())
            .then(data => {
                hideLoading('explain-loader');
                
                if (data.success) {
                    // 显示代码解释
                    resetResultArea();
                    document.getElementById('explained-code-result').style.display = 'block';
                    
                    // 格式化解释内容
                    const formattedExplanation = formatExplanation(data.result);
                    document.getElementById('explained-code-content').innerHTML = formattedExplanation;
                } else {
                    showError(data.error || '代码解释失败，请稍后重试');
                }
            })
            .catch(error => {
                hideLoading('explain-loader');
                showError('请求失败: ' + error.message);
            });
        }
        
        // 审查代码
        function reviewCode() {
            const language = document.getElementById('review-language').value;
            const code = document.getElementById('review-code').value.trim();
            
            if (!code) {
                showError('请输入需要审查的代码');
                return;
            }
            
            // 构建请求参数
            const requestData = {
                action: 'review',
                language: language,
                code: code,
                checkPerformance: document.getElementById('check-performance').checked,
                checkSecurity: document.getElementById('check-security').checked,
                checkBestPractices: document.getElementById('check-best-practices').checked,
                checkBugs: document.getElementById('check-bugs').checked
            };
            
            // 显示加载状态
            showLoading('review-loader');
            
            // 发送请求
            fetch('/api/code', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestData)
            })
            .then(response => response.json())
            .then(data => {
                hideLoading('review-loader');
                
                if (data.success) {
                    // 显示代码审查结果
                    resetResultArea();
                    document.getElementById('reviewed-code-result').style.display = 'block';
                    
                    // 填充审查结果
                    populateReviewResults(data);
                } else {
                    showError(data.error || '代码审查失败，请稍后重试');
                }
            })
            .catch(error => {
                hideLoading('review-loader');
                showError('请求失败: ' + error.message);
            });
        }
        
        // 格式化解释内容
        function formatExplanation(explanation) {
            // 将文本按段落分割并添加HTML格式
            const paragraphs = explanation.split('\n\n');
            return paragraphs.map(p => `<p>${p}</p>`).join('');
        }
        
        // 填充审查结果
        function populateReviewResults(data) {
            // 显示总体评价
            const overall = document.getElementById('review-overall');
            const progressBar = document.getElementById('review-progress-bar');
            
            // 根据分数设置评价等级
            let score = data.score || 85;
            let rating = '良好';
            let color = 'bg-success';
            
            if (score >= 90) {
                rating = '优秀';
                color = 'bg-success';
            } else if (score >= 75) {
                rating = '良好';
                color = 'bg-success';
            } else if (score >= 60) {
                rating = '一般';
                color = 'bg-warning';
            } else {
                rating = '较差';
                color = 'bg-danger';
            }
            
            overall.textContent = rating;
            overall.className = `badge ${color}`;
            progressBar.className = `progress-bar ${color}`;
            progressBar.style.width = `${score}%`;
            progressBar.setAttribute('aria-valuenow', score);
            
            // 显示性能优化建议
            const performanceContent = document.getElementById('review-performance-content');
            if (data.performanceSuggestions && data.performanceSuggestions.length > 0) {
                performanceContent.innerHTML = data.performanceSuggestions.map(s => `<p>- ${s}</p>`).join('');
            } else {
                performanceContent.innerHTML = '<p class="text-muted">未发现明显的性能问题。</p>';
            }
            
            // 显示安全性问题
            const securityContent = document.getElementById('review-security-content');
            if (data.securityIssues && data.securityIssues.length > 0) {
                securityContent.innerHTML = data.securityIssues.map(s => `<p>- ${s}</p>`).join('');
            } else {
                securityContent.innerHTML = '<p class="text-muted">未发现明显的安全问题。</p>';
            }
            
            // 显示最佳实践建议
            const practicesContent = document.getElementById('review-practices-content');
            if (data.bestPractices && data.bestPractices.length > 0) {
                practicesContent.innerHTML = data.bestPractices.map(s => `<p>- ${s}</p>`).join('');
            } else {
                practicesContent.innerHTML = '<p class="text-muted">代码符合最佳实践。</p>';
            }
            
            // 显示潜在bug
            const bugsContent = document.getElementById('review-bugs-content');
            if (data.potentialBugs && data.potentialBugs.length > 0) {
                bugsContent.innerHTML = data.potentialBugs.map(s => `<p>- ${s}</p>`).join('');
            } else {
                bugsContent.innerHTML = '<p class="text-muted">未发现明显的bug。</p>';
            }
            
            // 显示改进后的代码
            const improvedCode = document.getElementById('review-improved-code');
            if (data.improvedCode) {
                improvedCode.textContent = data.improvedCode;
                improvedCode.className = `language-${data.language || 'java'}`;
                hljs.highlightElement(improvedCode);
            } else {
                improvedCode.textContent = '// 未提供改进后的代码';
            }
        }
        
        // 复制生成的代码
        function copyGeneratedCode() {
            const code = document.getElementById('generated-code-output').textContent;
            navigator.clipboard.writeText(code).then(() => {
                // 显示复制成功的提示
                const btn = document.getElementById('copy-generated-code');
                const originalText = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-check"></i> 已复制';
                btn.classList.add('btn-primary');
                btn.classList.remove('btn-outline-primary');
                
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.classList.remove('btn-primary');
                    btn.classList.add('btn-outline-primary');
                }, 2000);
            });
        }
        
        // 下载生成的代码
        function downloadGeneratedCode() {
            const code = document.getElementById('generated-code-output').textContent;
            const language = document.getElementById('generate-language').value;
            
            // 根据语言设置文件扩展名
            const extensions = {
                'java': 'java',
                'python': 'py',
                'javascript': 'js',
                'typescript': 'ts',
                'csharp': 'cs',
                'cpp': 'cpp',
                'go': 'go',
                'rust': 'rs',
                'kotlin': 'kt',
                'swift': 'swift'
            };
            
            const extension = extensions[language] || 'txt';
            const fileName = `generated-code.${extension}`;
            
            // 创建下载链接
            const blob = new Blob([code], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        // 加载代码模板
        function loadTemplate(templateId) {
            // 显示代码生成标签
            showTab('generate');
            
            // 根据模板ID设置相应的内容
            let language = 'java';
            let prompt = '';
            
            switch(templateId) {
                case 'quick-sort':
                    language = 'java';
                    prompt = '编写一个Java方法，实现快速排序算法，要求：\n1. 对整数数组进行排序\n2. 包含详细的注释解释算法原理\n3. 考虑边界情况的处理\n4. 分析时间复杂度';
                    break;
                case 'data-analysis':
                    language = 'python';
                    prompt = '使用Python和Pandas库编写数据处理代码，要求：\n1. 读取CSV文件数据\n2. 对数据进行清洗和预处理\n3. 计算基本统计信息\n4. 生成简单的数据可视化图表\n5. 包含详细的注释说明每一步操作';
                    break;
                case 'async-js':
                    language = 'javascript';
                    prompt = '编写JavaScript异步操作代码，要求：\n1. 展示Promise的基本用法\n2. 实现async/await处理异步操作\n3. 处理错误和异常情况\n4. 模拟多个异步API请求的并发处理\n5. 包含详细的注释说明';
                    break;
            }
            
            // 设置表单值
            document.getElementById('generate-language').value = language;
            document.getElementById('generate-prompt').value = prompt;
        }
    </script>
</body>
</html>